---
name: Build Binary

"on":
  workflow_run:
    workflows: ["Publish - PyPI Production"]
    types: [completed]
  workflow_dispatch:
    inputs:
      arch:
        description: "Target architecture"
        required: true
        default: "arm64"
        type: choice
        options:
          - arm64
          - x86_64
          - universal

permissions:
  contents: write

jobs:
  get-release-info:
    name: Get Release Info
    runs-on: ubuntu-latest
    # Only run on workflow_dispatch or successful workflow_run (skip actions-v* tags)
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       !startsWith(github.event.workflow_run.head_branch, 'actions-v'))
    outputs:
      release_tag: ${{ steps.get-tag.outputs.tag }}

    steps:
      - name: Get release tag
        id: get-tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            TAG="${{ github.event.workflow_run.head_branch }}"
          else
            # For workflow_dispatch, get latest release tag
            TAG=$(gh release view --json tagName -q .tagName 2>/dev/null || echo "")
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Release tag: $TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS Binary
    needs: get-release-info
    runs-on: macos-latest
    strategy:
      matrix:
        arch: >-
          ${{
            github.event_name == 'workflow_dispatch' &&
            github.event.inputs.arch != 'universal' &&
            fromJSON(format('["{0}"]', github.event.inputs.arch)) ||
            fromJSON('["arm64", "x86_64"]')
          }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9
        with:
          egress-policy: "block"
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            codeload.github.com:443
            objects.githubusercontent.com:443
            pypi.org:443
            files.pythonhosted.org:443
            uploads.github.com:443
            nuitka.net:443

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv sync --group build --group dev

      - name: Build binary
        run: |
          uv run python scripts/build/build_macos.py \
            --arch ${{ matrix.arch }} \
            --skip-verify
        env:
          PYTHONUNBUFFERED: "1"

      - name: Verify binary
        run: |
          ls -lh dist/nuitka/
          # Fail if binary can't execute --version (required for valid build)
          ./dist/nuitka/lintro --version
          # Show help output for debugging (non-fatal)
          ./dist/nuitka/lintro --help | head -20 || echo "Help output truncated"

      - name: Rename binary with architecture
        run: |
          mv dist/nuitka/lintro dist/nuitka/lintro-macos-${{ matrix.arch }}

      - name: Calculate SHA256
        id: sha256
        run: |
          BINARY="dist/nuitka/lintro-macos-${{ matrix.arch }}"
          SHA=$(shasum -a 256 "$BINARY" | cut -d' ' -f1)
          echo "sha256=$SHA" >> "$GITHUB_OUTPUT"
          echo "SHA256 for ${{ matrix.arch }}: $SHA"

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: lintro-macos-${{ matrix.arch }}
          path: dist/nuitka/lintro-macos-${{ matrix.arch }}
          retention-days: 7

      - name: Save SHA256 to file
        run: |
          echo "${{ steps.sha256.outputs.sha256 }}" > sha256-${{ matrix.arch }}.txt

      - name: Upload SHA256 file
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: sha256-${{ matrix.arch }}
          path: sha256-${{ matrix.arch }}.txt
          retention-days: 7

      - name: Upload to release
        if: >-
          github.event_name == 'workflow_run' &&
          needs.get-release-info.outputs.release_tag != ''
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ needs.get-release-info.outputs.release_tag }}
          files: dist/nuitka/lintro-macos-${{ matrix.arch }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-universal-binary:
    name: Create Universal Binary
    needs: [get-release-info, build-macos]
    runs-on: macos-latest
    if: >-
      github.event_name == 'workflow_run' ||
      (github.event_name == 'workflow_dispatch' &&
       github.event.inputs.arch == 'universal')

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9
        with:
          egress-policy: "block"
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            uploads.github.com:443

      - name: Download arm64 binary
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: lintro-macos-arm64
          path: binaries/

      - name: Download x86_64 binary
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: lintro-macos-x86_64
          path: binaries/

      - name: Create universal binary
        run: |
          lipo -create \
            binaries/lintro-macos-arm64 \
            binaries/lintro-macos-x86_64 \
            -output binaries/lintro-macos-universal
          chmod +x binaries/lintro-macos-universal

      - name: Verify universal binary
        run: |
          file binaries/lintro-macos-universal
          ls -lh binaries/lintro-macos-universal

      - name: Upload universal artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: lintro-macos-universal
          path: binaries/lintro-macos-universal
          retention-days: 7

      - name: Upload to release
        if: >-
          github.event_name == 'workflow_run' &&
          needs.get-release-info.outputs.release_tag != ''
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ needs.get-release-info.outputs.release_tag }}
          files: binaries/lintro-macos-universal
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Formula
    needs: [get-release-info, build-macos]
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_run' &&
      needs.get-release-info.outputs.release_tag != ''

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9
        with:
          egress-policy: "block"
          allowed-endpoints: >
            github.com:443
            api.github.com:443

      - name: Checkout lintro scripts and actions
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          sparse-checkout: |
            scripts
            .github/actions
          path: lintro

      - name: Download SHA256 artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          pattern: sha256-*
          path: checksums/
          merge-multiple: true

      - name: Read checksums
        id: checksums
        run: |
          ARM64_SHA=$(cat checksums/sha256-arm64.txt)
          X86_64_SHA=$(cat checksums/sha256-x86_64.txt)
          echo "arm64_sha256=$ARM64_SHA" >> "$GITHUB_OUTPUT"
          echo "x86_64_sha256=$X86_64_SHA" >> "$GITHUB_OUTPUT"
          echo "ARM64 SHA256: $ARM64_SHA"
          echo "x86_64 SHA256: $X86_64_SHA"

      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ needs.get-release-info.outputs.release_tag }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION from tag: $TAG"

      - name: Checkout homebrew-tap
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          repository: TurboCoder13/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Generate formula
        run: |
          lintro/scripts/ci/homebrew/generate-binary-formula.sh \
            "${{ steps.version.outputs.version }}" \
            "${{ steps.checksums.outputs.arm64_sha256 }}" \
            "${{ steps.checksums.outputs.x86_64_sha256 }}" \
            "homebrew-tap/Formula/lintro-bin.rb"

      - name: Commit and push
        env:
          WORKING_DIR: homebrew-tap
        run: |
          lintro/scripts/ci/git-commit-push.sh \
            "Formula/lintro-bin.rb" \
            "Update lintro-bin to ${{ steps.version.outputs.version }}"
