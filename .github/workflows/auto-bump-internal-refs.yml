---
name: Auto-bump internal refs

'on':
  push:
    branches: [main]
    paths:
      - .github/actions/**
      - .github/workflows/reusable-*.yml
  workflow_dispatch:
    inputs:
      sha:
        description: Provide the full 40-char commit SHA to pin internal refs to
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Harden and Checkout
        uses: TurboCoder13/py-lintro/.github/actions/harden-and-checkout@cf101f21687973ed5d9f2000ad5698d3708dd2fd
        with:
          fetch-depth: 0

      - name: Bump internal refs to current SHA
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            scripts/ci/bump-internal-refs.sh "${{ inputs.sha }}"
          else
            scripts/ci/bump-internal-refs.sh "${{ github.sha }}"
          fi

      - name: Detect changes
        id: diff
        run: scripts/ci/detect-changes.sh

      - name: Configure git for PR creation
        if: steps.diff.outputs.has_changes == 'true'
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global commit.gpgsign false

      - name: Create PR if changes
        id: cpr
        if: steps.diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: bump internal workflow/action refs to latest SHA'
          title: 'chore: bump internal refs to latest SHA'
          body: |
            Automated update of internal action/workflow references to the
            latest commit SHA to satisfy org policy for pinned refs.
          branch: chore/bump-internal-refs-${{ github.run_id }}-${{ github.sha }}
          labels: maintenance
          delete-branch: true
