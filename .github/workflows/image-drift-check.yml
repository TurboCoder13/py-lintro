# SPDX-License-Identifier: MIT
# For license details, see the repository root LICENSE file.
---
name: Image Drift Check

'on':
  schedule:
    # Weekly on Monday at 02:00 UTC
    - cron: '0 2 * * 1'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  verify-images:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    timeout-minutes: 20
    defaults:
      run:
        shell: bash
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9
        with:
          egress-policy: 'block'
          allowed-endpoints: >
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            docker.io:443
            registry-1.docker.io:443
            auth.docker.io:443

      - name: Pull tools image
        run: docker pull ghcr.io/lgtm-hq/lintro-tools:latest

      - name: Verify tools image against manifest
        run: >
          docker run --rm
          ghcr.io/lgtm-hq/lintro-tools:latest
          python3 /app/scripts/ci/verify-manifest-tools.py
          --manifest /app/lintro/tools/manifest.json
          --tiers tools

      - name: Pull main image
        run: docker pull ghcr.io/lgtm-hq/py-lintro:latest

      - name: Smoke test main image
        run: docker run --rm ghcr.io/lgtm-hq/py-lintro:latest lintro --version

      - name: Pull base image
        run: docker pull ghcr.io/lgtm-hq/py-lintro:base

      - name: Smoke test base image
        run: docker run --rm ghcr.io/lgtm-hq/py-lintro:base lintro --version
