# SPDX-License-Identifier: MIT
# For license details, see the repository root LICENSE file.
---
name: Testing - Built Package Validation
# Tests lintro installed from built distributions (wheel and sdist) rather than
# editable mode. This catches packaging issues like circular imports, missing files,
# and entry point errors that only manifest when installed as a dependency.

'on':
  push:
    branches: [main]
    paths:
      - '**.py'
      - pyproject.toml
      - MANIFEST.in
      - .github/workflows/test-built-package.yml
      - scripts/ci/test-*.sh
  pull_request:
    branches: [main]
    paths:
      - '**.py'
      - pyproject.toml
      - MANIFEST.in
      - scripts/ci/test-*.sh
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-package-install:
    name: Validate ${{ matrix.package-type }} installation
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        package-type: [wheel, sdist]
        include:
          - package-type: wheel
            build-flag: --wheel
          - package-type: sdist
            build-flag: --sdist
    concurrency:
      group: built-package-${{ matrix.package-type }}-${{ github.ref }}
      cancel-in-progress: true
    defaults:
      run:
        shell: bash
    if: >-
      github.event_name != 'pull_request' ||
      github.event.pull_request.draft == false
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@92c522aaa6f53af082553dedc1596c80b71aba33
        with:
          egress-policy: 'block'
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            codeload.github.com:443
            downloads.github.com:443
            release-assets.githubusercontent.com:443
            objects.githubusercontent.com:443
            pypi.org:443
            files.pythonhosted.org:443

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Egress audit (allowlist verification)
        # yamllint disable-line rule:line-length
        uses: TurboCoder13/py-lintro/.github/actions/egress-audit-lite@448d8d96fea3374dd1e534f67afd8d61182c0de7
        with:
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            codeload.github.com:443
            downloads.github.com:443
            release-assets.githubusercontent.com:443
            objects.githubusercontent.com:443
            pypi.org:443
            files.pythonhosted.org:443
          fail-on-missing: 'true'

      - name: Environment setup
        # yamllint disable-line rule:line-length
        uses: TurboCoder13/py-lintro/.github/actions/setup-env@448d8d96fea3374dd1e534f67afd8d61182c0de7
        with:
          python-version: '3.13'
        env:
          BOOTSTRAP_SKIP_SYNC: '1'
          BOOTSTRAP_SKIP_INSTALL_TOOLS: '1'

      - name: Build ${{ matrix.package-type }}
        run: uv build ${{ matrix.build-flag }} --out-dir dist/

      - name: Create isolated test environment
        run: bash scripts/ci/test-venv-setup.sh

      - name: Install ${{ matrix.package-type }} in isolated environment
        run: bash scripts/ci/test-install-package.sh ${{ matrix.package-type }}

      - name: Verify package imports
        run: bash scripts/ci/test-verify-imports.sh ${{ matrix.package-type }}

      - name: Verify CLI entry points
        run: bash scripts/ci/test-verify-cli.sh

      - name: Run built package integration test (wheel only)
        if: matrix.package-type == 'wheel'
        run: bash scripts/ci/test-built-package-integration.sh
