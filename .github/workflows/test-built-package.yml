# SPDX-License-Identifier: MIT
# For license details, see the repository root LICENSE file.
---
name: Testing - Built Package Validation
# Tests lintro installed from built distributions (wheel and sdist) rather than
# editable mode. This catches packaging issues like circular imports, missing files,
# and entry point errors that only manifest when installed as a dependency.

'on':
  push:
    branches: [main]
    paths:
      - '**.py'
      - pyproject.toml
      - MANIFEST.in
      - .github/workflows/test-built-package.yml
      - scripts/ci/test-*.sh
  pull_request:
    branches: [main]
    paths:
      - '**.py'
      - pyproject.toml
      - MANIFEST.in
      - scripts/ci/test-*.sh
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-package-install:
    name: Validate ${{ matrix.package-type }} installation
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        package-type: [wheel, sdist]
        include:
          - package-type: wheel
            build-flag: --wheel
          - package-type: sdist
            build-flag: --sdist
    concurrency:
      group: built-package-${{ matrix.package-type }}-${{ github.ref }}
      cancel-in-progress: true
    defaults:
      run:
        shell: bash
    if: >-
      github.event_name != 'pull_request' ||
      github.event.pull_request.draft == false
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2
        with:
          egress-policy: 'block'
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            codeload.github.com:443
            release-assets.githubusercontent.com:443
            objects.githubusercontent.com:443
            pypi.org:443
            files.pythonhosted.org:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Egress audit (allowlist verification)
        env:
          EGRESS_ALLOWED_ENDPOINTS: >
            github.com:443
            api.github.com:443
            codeload.github.com:443
            release-assets.githubusercontent.com:443
            objects.githubusercontent.com:443
            pypi.org:443
            files.pythonhosted.org:443
        run: scripts/ci/maintenance/egress-audit-lite.sh "true"

      - name: Environment setup
        uses: ./.github/actions/setup-env
        with:
          python-version: '3.13'
        env:
          BOOTSTRAP_SKIP_SYNC: '1'
          BOOTSTRAP_SKIP_INSTALL_TOOLS: '1'

      - name: Build ${{ matrix.package-type }}
        run: uv build ${{ matrix.build-flag }} --out-dir dist/

      - name: Create isolated test environment
        run: bash scripts/ci/test-venv-setup.sh

      - name: Install ${{ matrix.package-type }} in isolated environment
        run: bash scripts/ci/test-install-package.sh ${{ matrix.package-type }}

      - name: Verify package imports
        run: bash scripts/ci/test-verify-imports.sh ${{ matrix.package-type }}

      - name: Verify CLI entry points
        run: bash scripts/ci/test-verify-cli.sh

      - name: Run built package integration test (wheel only)
        if: matrix.package-type == 'wheel'
        run: bash scripts/ci/test-built-package-integration.sh
